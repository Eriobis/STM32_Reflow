/**********************************************************************************************************************
 * @file    max6675.c
 * @author  Simon Benoit
 * @date    06-12-2017
 * @brief
 *********************************************************************************************************************/

/* Includes ---------------------------------------------------------------------------------------------------------*/

#include "stm32l0xx_hal.h"
#include "main.h"

/* Local Defines ----------------------------------------------------------------------------------------------------*/

/* Local Typedefs ---------------------------------------------------------------------------------------------------*/

/* Forward Declarations ---------------------------------------------------------------------------------------------*/

static int16_t MAX6675_readData(void);

/* Local Constants --------------------------------------------------------------------------------------------------*/

/* Local Variables --------------------------------------------------------------------------------------------------*/

extern SPI_HandleTypeDef hspi1;

/* Local Functions --------------------------------------------------------------------------------------------------*/

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
static int16_t MAX6675_readData(void)
{
    uint8_t data[2];
    int16_t ret = 0;
    HAL_GPIO_WritePin(MAX6675_CS_Port, MAX6675_CS_Pin, GPIO_PIN_RESET);
    HAL_SPI_Receive(&hspi1, data, 2, 20);
    HAL_GPIO_WritePin(MAX6675_CS_Port, MAX6675_CS_Pin, GPIO_PIN_SET);
    ret = data[0] << 8 | data[1];
    return ret;
}

/* Global Functions -------------------------------------------------------------------------------------------------*/

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
float MAX6675_readCelsius(void)
{
    int16_t v = MAX6675_readData();
    v >>= 3;
    return ((float)v/(float)4.0);
}

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
char MAX6675_readStatus(void)
{
    int16_t v = MAX6675_readData();
    return v & 0x7;
}
