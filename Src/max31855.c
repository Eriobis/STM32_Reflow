/**********************************************************************************************************************
 * @file    max31855.c
 * @author  Simon Benoit
 * @date    06-12-2017
 * @brief   
 *********************************************************************************************************************/

/* Includes ---------------------------------------------------------------------------------------------------------*/

#include "stm32l0xx_hal.h"

/* Local Defines ----------------------------------------------------------------------------------------------------*/

/* Local Typedefs ---------------------------------------------------------------------------------------------------*/

/* Forward Declarations ---------------------------------------------------------------------------------------------*/

static int16_t MAX31855_readFirst16bits(void);
static int16_t MAX31855_readSecond32bits(void);

/* Local Constants --------------------------------------------------------------------------------------------------*/

/* Local Variables --------------------------------------------------------------------------------------------------*/

extern SPI_HandleTypeDef hspi1;

/* Local Functions --------------------------------------------------------------------------------------------------*/

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief  
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
static int16_t MAX31855_readFirst16bits(void)
{
    uint8_t data[2];
    int16_t ret = 0;
    HAL_SPI_Receive(&hspi1, data, 2, 20);
    ret = data[0] << 8 | data[1];
    return ret;
}

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief  
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
static int16_t MAX31855_readSecond32bits(void)
{
    uint8_t data[4];
    int16_t ret = 0;
    HAL_SPI_Receive(&hspi1, data, 4, 20);
    ret = data[2] << 8 | data[3];
    return ret;
}

/* Global Functions -------------------------------------------------------------------------------------------------*/

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief  
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
float MAX31855_readCelsius(void)
{
    int16_t v = MAX31855_readFirst16bits();
    if (v & 0x1)
        return 9999.0;
    if (v & 0x8000)
        return (((~v) & 0xfffc) + 0x4) / -32.0;
    else
        return (v & 0xfffc) / 32.0;
}

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief  
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
float MAX31855_readCJCelsius(void)
{
    int16_t v = MAX31855_readSecond32bits();
    if (v & 0x8000)
        return (((~v) & 0xfff0) + 0x10) / -512.0;
    else
        return (v & 0xfff0) / 512.0;
}

/**
  *--------------------------------------------------------------------------------------------------------------------
  * @brief  
  *
  * @param  none
  *
  * @retval none
  *
  *--------------------------------------------------------------------------------------------------------------------
  */
char MAX31855_readStatus(void)
{
    int16_t v = MAX31855_readSecond32bits();
    return v & 0x7;
}